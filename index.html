<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reunião de Sócios</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, orderBy, addDoc, serverTimestamp, deleteDoc, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // As variáveis de configuração do Firebase são fornecidas pelo ambiente.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null;
        let userRole = null;
        let userName = null;
        let idNumber = null;

        // Seção de UI
        const loginSection = document.getElementById('login-section');
        const registerSection = document.getElementById('register-section');
        const meetingSection = document.getElementById('meeting-section');
        const registerForm = document.getElementById('register-form');
        const loginForm = document.getElementById('login-form');
        const meetingForm = document.getElementById('meeting-form');
        const topicsList = document.getElementById('topics-list');
        const commentsList = document.getElementById('comments-list');
        const currentUserNameEl = document.getElementById('current-user-name');
        const currentUserIdEl = document.getElementById('current-user-id');
        const logoutBtn = document.getElementById('logout-btn');

        // Navegação entre seções
        document.getElementById('show-register').addEventListener('click', () => {
            loginSection.classList.add('hidden');
            registerSection.classList.remove('hidden');
        });
        document.getElementById('show-login').addEventListener('click', () => {
            registerSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        });

        // Lógica de Autenticação
        const HOST_PASSWORD = "Reuniao2025@";

        async function registerUser(e) {
            e.preventDefault();
            const name = document.getElementById('register-name').value;
            const id = document.getElementById('register-id').value;
            const password = document.getElementById('register-password').value;

            try {
                // Checa se o usuário já existe no banco de dados
                const userDocRef = doc(db, `/artifacts/${appId}/users/${auth.currentUser.uid}/users/${id}`);
                const userDocSnap = await getDoc(userDocRef);

                if (userDocSnap.exists()) {
                    showMessage('ID de sócio já existe. Por favor, faça login ou use outro ID.', 'error');
                    return;
                }

                const role = password === HOST_PASSWORD ? 'host' : 'member';
                await setDoc(userDocRef, {
                    name,
                    idNumber: id,
                    password,
                    role,
                    createdAt: serverTimestamp()
                });

                showMessage('Cadastro realizado com sucesso! Por favor, faça login.', 'success');
                registerForm.reset();
                loginSection.classList.remove('hidden');
                registerSection.classList.add('hidden');
            } catch (error) {
                console.error("Erro ao cadastrar:", error);
                showMessage('Erro ao cadastrar. Tente novamente.', 'error');
            }
        }

        async function loginUser(e) {
            e.preventDefault();
            const id = document.getElementById('login-id').value;
            const password = document.getElementById('login-password').value;

            try {
                // Busca o documento do usuário
                const userDocRef = doc(db, `/artifacts/${appId}/users/${auth.currentUser.uid}/users/${id}`);
                const userDocSnap = await getDoc(userDocRef);

                if (!userDocSnap.exists() || userDocSnap.data().password !== password) {
                    showMessage('ID ou senha incorretos.', 'error');
                    return;
                }

                const userData = userDocSnap.data();
                userId = auth.currentUser.uid;
                userRole = userData.role;
                userName = userData.name;
                idNumber = userData.idNumber;

                showMeetingApp();
                showMessage('Login realizado com sucesso!', 'success');
            } catch (error) {
                console.error("Erro ao fazer login:", error);
                showMessage('Erro ao fazer login. Tente novamente.', 'error');
            }
        }

        function showMeetingApp() {
            loginSection.classList.add('hidden');
            registerSection.classList.add('hidden');
            meetingSection.classList.remove('hidden');
            currentUserNameEl.textContent = `Olá, ${userName}`;
            currentUserIdEl.textContent = `Seu ID de Usuário (compartilhe com os sócios): ${userId}`;
            loadTopics();
        }

        function showLoginPage() {
            meetingSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
            userId = null;
            userRole = null;
            userName = null;
            idNumber = null;
        }

        logoutBtn.addEventListener('click', showLoginPage);
        registerForm.addEventListener('submit', registerUser);
        loginForm.addEventListener('submit', loginUser);

        // Lógica dos Comentários e Tópicos
        let activeTopicId = null;

        function loadTopics() {
            const topicsCollection = collection(db, `/artifacts/${appId}/public/data/topics`);
            const topicsQuery = query(topicsCollection, orderBy('createdAt', 'asc'));

            onSnapshot(topicsQuery, (snapshot) => {
                topicsList.innerHTML = '';
                snapshot.forEach(doc => {
                    const topic = doc.data();
                    const topicBtn = document.createElement('button');
                    topicBtn.className = `p-2 my-1 rounded-lg w-full text-left transition-colors duration-200 ${activeTopicId === doc.id ? 'bg-indigo-600 text-white' : 'bg-gray-200 text-gray-800 hover:bg-indigo-500 hover:text-white'}`;
                    topicBtn.textContent = topic.title;
                    topicBtn.addEventListener('click', () => {
                        activeTopicId = doc.id;
                        loadComments(activeTopicId);
                        // Re-renderiza os botões para atualizar o estado ativo
                        document.querySelectorAll('#topics-list button').forEach(btn => {
                            btn.classList.remove('bg-indigo-600', 'text-white');
                            btn.classList.add('bg-gray-200', 'text-gray-800');
                        });
                        topicBtn.classList.add('bg-indigo-600', 'text-white');
                        topicBtn.classList.remove('bg-gray-200', 'text-gray-800');
                    });
                    topicsList.appendChild(topicBtn);
                });

                // Se houver tópicos e nenhum estiver ativo, ativa o primeiro
                if (snapshot.docs.length > 0 && !activeTopicId) {
                    activeTopicId = snapshot.docs[0].id;
                    loadComments(activeTopicId);
                    topicsList.querySelector('button').classList.remove('bg-gray-200', 'text-gray-800');
                    topicsList.querySelector('button').classList.add('bg-indigo-600', 'text-white');
                }
            });
        }

        function loadComments(topicId) {
            const commentsCollection = collection(db, `/artifacts/${appId}/public/data/comments`);
            const commentsQuery = query(commentsCollection, orderBy('createdAt', 'asc'));

            onSnapshot(commentsQuery, (snapshot) => {
                commentsList.innerHTML = '';
                const topicComments = snapshot.docs
                    .filter(doc => doc.data().topicId === topicId)
                    .map(doc => ({ id: doc.id, ...doc.data() }));

                if (topicComments.length === 0) {
                    commentsList.innerHTML = '<p class="text-center text-gray-500">Nenhum comentário ainda. Seja o primeiro a adicionar uma opinião!</p>';
                } else {
                    topicComments.forEach(comment => {
                        const commentEl = document.createElement('div');
                        commentEl.className = 'bg-gray-100 p-4 rounded-lg shadow mb-3';

                        const commentHeader = document.createElement('div');
                        commentHeader.className = 'flex justify-between items-center mb-2';

                        const commentAuthor = document.createElement('span');
                        commentAuthor.className = 'font-semibold';
                        commentAuthor.textContent = `${comment.userName} (${comment.userRole === 'host' ? 'Host' : 'Sócio'})`;

                        commentHeader.appendChild(commentAuthor);

                        if (userRole === 'host') {
                            const deleteBtn = document.createElement('button');
                            deleteBtn.className = 'text-red-500 hover:text-red-700 transition-colors duration-200';
                            deleteBtn.textContent = 'Excluir';
                            deleteBtn.addEventListener('click', async () => {
                                try {
                                    await deleteDoc(doc(db, `/artifacts/${appId}/public/data/comments/${comment.id}`));
                                    showMessage('Comentário excluído!', 'success');
                                } catch (error) {
                                    console.error('Erro ao excluir comentário:', error);
                                    showMessage('Erro ao excluir comentário. Tente novamente.', 'error');
                                }
                            });
                            commentHeader.appendChild(deleteBtn);
                        }

                        commentEl.appendChild(commentHeader);

                        const commentText = document.createElement('p');
                        commentText.className = 'text-gray-700 whitespace-pre-wrap';
                        commentText.textContent = comment.commentText;

                        commentEl.appendChild(commentText);
                        commentsList.appendChild(commentEl);
                    });
                }
            });
        }

        meetingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const commentText = document.getElementById('comment-text').value;

            if (!activeTopicId) {
                showMessage('Por favor, selecione um tópico primeiro.', 'error');
                return;
            }
            if (!commentText.trim()) return;

            try {
                const commentsCollection = collection(db, `/artifacts/${appId}/public/data/comments`);
                await addDoc(commentsCollection, {
                    topicId: activeTopicId,
                    userId: userId,
                    userName: userName,
                    userRole: userRole,
                    commentText,
                    createdAt: serverTimestamp()
                });
                showMessage('Comentário adicionado!', 'success');
                document.getElementById('comment-text').value = '';
            } catch (error) {
                console.error("Erro ao adicionar comentário:", error);
                showMessage('Erro ao adicionar comentário. Tente novamente.', 'error');
            }
        });

        // Adiciona um tópico de exemplo (pode ser expandido para o host adicionar novos)
        async function addInitialTopics() {
            const topicsCollection = collection(db, `/artifacts/${appId}/public/data/topics`);
            const topics = [
                "Revisão do balanço financeiro",
                "Planejamento estratégico para 2024",
                "Novos projetos e investimentos",
                "Assuntos gerais e próximos passos"
            ];
            for (const title of topics) {
                const q = query(topicsCollection, where("title", "==", title));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    await addDoc(topicsCollection, {
                        title,
                        createdAt: serverTimestamp()
                    });
                }
            }
        }

        addInitialTopics();

        // Inicializa o app e o auth
        async function initializeFirebaseApp() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autenticação:", error);
            }
        }
        initializeFirebaseApp();

        // Sistema de mensagens
        function showMessage(msg, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = msg;
            messageBox.className = `p-3 mb-4 rounded-lg text-white font-semibold transition-all duration-300 ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => messageBox.classList.add('hidden'), 5000);
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }

        .container {
            max-width: 1200px;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div id="message-box" class="fixed top-4 right-4 z-50 p-4 rounded-lg hidden"></div>

    <!-- Login Section -->
    <section id="login-section" class="w-full max-w-sm p-6 bg-white rounded-xl shadow-lg">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Login dos Sócios</h2>
        <form id="login-form" class="space-y-4">
            <div>
                <label for="login-id" class="block text-sm font-medium text-gray-700">ID do Sócio</label>
                <input type="text" id="login-id" required
                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="login-password" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="login-password" required
                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Entrar</button>
        </form>
        <p class="mt-4 text-center text-sm text-gray-600">
            Não tem uma conta? <button id="show-register"
                class="text-indigo-600 hover:text-indigo-500 font-medium">Cadastre-se</button>
        </p>
    </section>

    <!-- Register Section -->
    <section id="register-section" class="w-full max-w-sm p-6 bg-white rounded-xl shadow-lg hidden">
        <h2 class="text-2xl font-bold mb-6 text-center text-gray-800">Novo Cadastro</h2>
        <form id="register-form" class="space-y-4">
            <div>
                <label for="register-name" class="block text-sm font-medium text-gray-700">Nome Completo</label>
                <input type="text" id="register-name" required
                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="register-id" class="block text-sm font-medium text-gray-700">ID de Sócio (Ex: 001)</label>
                <input type="text" id="register-id" required
                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <div>
                <label for="register-password" class="block text-sm font-medium text-gray-700">Senha</label>
                <input type="password" id="register-password" required
                    class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500">
            </div>
            <button type="submit"
                class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Cadastrar</button>
        </form>
        <p class="mt-4 text-center text-sm text-gray-600">
            Já tem uma conta? <button id="show-login" class="text-indigo-600 hover:text-indigo-500 font-medium">Faça
                login</button>
        </p>
    </section>

    <!-- Meeting Section -->
    <section id="meeting-section" class="w-full max-w-6xl p-6 bg-white rounded-xl shadow-lg hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold text-gray-800">Painel da Reunião</h1>
            <button id="logout-btn"
                class="text-sm text-gray-500 hover:text-gray-700 transition-colors duration-200">Sair</button>
        </div>

        <div class="mb-6 bg-gray-50 p-4 rounded-lg shadow-inner">
            <p id="current-user-name" class="text-lg font-semibold text-gray-700"></p>
            <p id="current-user-id" class="text-sm text-gray-500 mt-1"></p>
            <p class="text-sm text-gray-500 mt-2">
                Para que os outros sócios possam interagir, compartilhe o seu "ID de Usuário" com eles.
                Eles usarão o próprio "ID de Sócio" e a senha para fazer login na mesma conta.
            </p>
        </div>

        <div class="flex flex-col md:flex-row gap-6">
            <!-- Tópicos -->
            <div class="w-full md:w-1/3">
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Tópicos de Discussão</h3>
                <div id="topics-list" class="flex flex-col space-y-2">
                    <!-- Tópicos serão carregados aqui -->
                </div>
            </div>

            <!-- Discussão e Comentários -->
            <div class="w-full md:w-2/3">
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Discussão</h3>
                <div id="comments-list"
                    class="bg-gray-50 p-4 rounded-lg shadow-inner min-h-[300px] max-h-[500px] overflow-y-auto mb-4">
                    <!-- Comentários serão carregados aqui -->
                </div>

                <form id="meeting-form" class="flex items-center gap-2">
                    <textarea id="comment-text" placeholder="Adicionar sua opinião..." rows="2"
                        class="flex-grow p-3 border border-gray-300 rounded-md resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500"></textarea>
                    <button type="submit"
                        class="self-end px-6 py-3 bg-indigo-600 text-white font-semibold rounded-md shadow-lg hover:bg-indigo-700 transition-colors duration-200">Enviar</button>
                </form>
            </div>
        </div>
    </section>
</body>

</html>
